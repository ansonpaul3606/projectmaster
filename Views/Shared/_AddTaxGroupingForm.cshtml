@*----------------------------------------------------------------------
    Created By	: Amritha Ak
    Created On	: 11/07/2022
    Purpose		: tax group
    -------------------------------------------------------------------------
    Modification
    On			By					OMID/Remarks
    -------------------------------------------------------------------------
    -------------------------------------------------------------------------*@
@model PerfectWebERP.Models.TaxGroupingModel.TaxGroupView
    <style>
        [perfect-tempTable-th-name=ID_TaxType] {
            display: none
        }

        [perfect-tempTable-td-name=ID_TaxType] {
            display: none
        }
    </style>

    <div class="card ">

        <div class="card-header">
            <h4 class="card-title col-12">Tax Group</h4>
            <span title="To View List" onclick="fn_showListView();"><svg id="Layer_1" class="layer" stroke="currentColor" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 122.88 122.54"><title>To View List</title><path class="viewlst" d="M4.69,0H46.22a4.71,4.71,0,0,1,4.69,4.69V46a4.69,4.69,0,0,1-4.69,4.69H4.69a4.65,4.65,0,0,1-3.31-1.38l-.09-.09A4.67,4.67,0,0,1,0,46V4.69A4.71,4.71,0,0,1,4.69,0ZM89.44,61.94a26.56,26.56,0,0,1,10.18,2l.07,0a26.61,26.61,0,0,1,15.25,32.16,26.18,26.18,0,0,1-2.7,6.11l10.3,11.24a1.27,1.27,0,0,1-.07,1.8l-7.57,6.9a1.27,1.27,0,0,1-1.79-.07l-9.86-10.85a26.36,26.36,0,0,1-6.1,2.74,26.87,26.87,0,0,1-7.71,1.13,26.51,26.51,0,0,1-10.17-2l-.07,0A26.64,26.64,0,0,1,64.85,78.37l0-.07A26.6,26.6,0,0,1,89.44,61.94Zm15,11.59a21.38,21.38,0,0,0-6.89-4.61l-.06,0a21.22,21.22,0,0,0-23.07,4.64l-.07.07a21.25,21.25,0,0,0-4.54,6.83l0,.06a21.32,21.32,0,0,0-1.58,8.06,21.26,21.26,0,0,0,29.35,19.62,21.54,21.54,0,0,0,6.89-4.61l.07-.07a21.09,21.09,0,0,0,4.54-6.83l0-.06a21.35,21.35,0,0,0,0-16.17,21.34,21.34,0,0,0-4.62-6.9ZM4.69,63.2H46.22a4.71,4.71,0,0,1,4.69,4.7v41.34a4.68,4.68,0,0,1-4.69,4.69H4.69A4.69,4.69,0,0,1,0,109.24V67.9a4.71,4.71,0,0,1,4.69-4.7ZM68.78,0h41.53A4.71,4.71,0,0,1,115,4.69V46a4.71,4.71,0,0,1-4.69,4.69H68.78A4.71,4.71,0,0,1,64.09,46V4.69a4.69,4.69,0,0,1,1.37-3.31l.1-.09A4.67,4.67,0,0,1,68.78,0Z"></path></svg></span>
        </div>
        <div class="card-body">
            <form id="" class="form-valide" perfect-class="form" action="#" method="post" perfect-onFormSuccess="">
                <div class="">
                    @Html.AntiForgeryToken()
                    <div class="row">




                        <div class="col-sm-6">
                            <div class="form-group row" perfect-class="formGroup">

                                <div class="col-sm-8">

                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group row" perfect-class="formGroup">

                                <div class="col-sm-8">

                                </div>
                            </div>
                        </div>

                        <div class="col-sm-6">
                            <div class="form-group row" perfect-class="formGroup">
                                <label class="col-sm-4 col-form-label">
                                    <span perfect-class="formGroupLabel"> Name</span>
                                    <span class="text-danger">*</span>
                                </label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control perfectValidate_string" id='idname'placeholder="" name="Name" perfect-class="formGroupControl" perfect-ctype="input" perfect-css="input"onchange="generateShortName(this)" />
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group row" perfect-class="formGroup">
                                <label class="col-sm-4 col-form-label">
                                    <span perfect-class="formGroupLabel"> Short Name</span>
                                    <span class="text-danger">*</span>
                                </label>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control perfectValidate_string" placeholder=""id="idshortname" name="ShortName" perfect-class="formGroupControl" perfect-ctype="input" perfect-css="input" />
                                </div>
                            </div>
                        </div>

                        <div class="col-sm-6">
                            <div class="form-group row" perfect-class="formGroup">
                                <label class="col-sm-4 col-form-label">
                                    <span perfect-class="formGroupLabel">Sort order</span>


                                </label>
                                <div class="col-sm-8">
                                    <div class=" input-group mb-2">
                                        <input type="number" class="form-control perfectValidate_numeric_nm" placeholder="" name="SortOrder" perfect-class="formGroupControl" perfect-ctype="select" perfect-css="input" value="@Model.SortOrder" min="0" />
                                    </div>
                                </div>
                            </div>
                        </div>



                    </div>

               

                <div class="row">
                    <div class="col-sm-12">
                        <div class="card">

                            <div class="card-body">
                                <div id="accordion-nine" class="accordion accordion-active-header">

                                    <div class="accordion__item">
                                        <div class="accordion__header" data-toggle="collapse"data-target="#active-header_collapseTwo" aria-expanded="true" disable>
                                            <span class="accordion__header--icon"></span>
                                            <span class="accordion__header--text">Tax Details</span>
                                           
                                        </div>
                                        <div id="active-header_collapseTwo" class="collapse accordion__body collapse show" data-parent="#accordion-nine">
                                            <div class="accordion__body--text">
                                                <div class="row">
                                                    <div class="col-sm-12" perfect-class="TempTableGroup">
                                                        <br />

                                                        <div class="row">
                                                            <div class="col-sm-4">
                                                                <div class="form-group row" perfect-class="formGroup">
                                                                    <label class="col-sm-4 col-form-label">
                                                                        <span perfect-class="formGroupLabel">Tax Type</span>
                                                                        <span class="text-danger">*</span>
                                                                        <input type="hidden" name="ID_TaxType" perfect-class="formGroupControl"id="ID_TaxType" perfect-ctype="hidden" perfect-tempTable-taxType="ID_TaxType" perfect-css="input" />
                                                                    </label>
                                                                    <div class="col-sm-8 PerError">
                                                                        <div class="input-group">
                                                                            <input type="text" class="form-control" name="TaxtyName" perfect-class="formGroupControl" perfect-ctype="input" perfect-css="input" perfect-tempTable-taxType="Tax Type" disabled />
                                                                           
                                                                            <div class="input-group-append">

                                                                                <button id="addcountry-jq-searchButton3" class="btn btn-primary fa fa-search" type="button" perfect-css="button" onclick="GetCmnPopUpSearchVal(this,34,'Tax Type List',['',''])" Criterea1="0" Criterea2="0" BindName="TaxtyName" BindVal="ID_TaxType"></button>
                                                                                @*<button id="addCustomer-jq-searchButton3" class="btn btn-primary fa fa-search" type="button" perfect-css="button" onclick="searchbtn(this)"></button>*@

                                                                            </div>

                                                                        </div>
                                                                        <div class="text-danger temptableError"></div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-sm-4" id="PercentText">
                                                                <div class="form-group row" perfect-class="formGroup">
                                                                    <label class="col-sm-4 col-form-label">
                                                                        <span perfect-class="formGroupLabel">Percentage</span>
                                                                        <span class="text-danger">*</span>
                                                                    </label>
                                                                    <div class="col-sm-5 PerError">
                                                                        <input type="text" class="form-control text-right"  min="0" placeholder="" name="TaxPercentage" id="TaxPercentage" oninput="decimalpnt(this,'TaxPercentage',3)" perfect-class="formGroupControl" perfect-ctype="input" perfect-css="input" perfect-tempTable-taxType="Percentage" />
                                                                        <span class="text-danger temptableError"></span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-sm-4">
                                                                <div class="form-group row" perfect-class="formGroup">
                                                                    @*<label class="col-sm-4 col-form-label" id="Amountlabel">
                                                                        <span perfect-class="formGroupLabel">Amount</span>

                                                                    </label>
                                                                    <div class="col-sm-5" id="AmountText">
                                                                        
                                                                        <input type="text" class="form-control text-right" min="0" placeholder="" name="AmountWise" id="AmountWise" perfect-class="formGroupControl" oninput="decimalpnt(this,'AmountWise',3)" perfect-ctype="input" perfect-css="input" perfect-tempTable-taxType="Amount Wise" /><span class="text-danger temptableError"></span>

                                                                    </div>*@

                                                                   
                                                                    <div>
                                                                        <button class="btn btn-primary1" id="idaddbutton" type="button" data-toggle="tooltip" data-placement="top" data-html="true" title="Add Tax Group" onclick="fn_createProductTable(this,'taxType',['ID_TaxType'])"><i class="fa fa-plus" aria-hidden="true"></i></button>
                                                                        &nbsp;&nbsp;   <button class="btn btn-light1" id="reset" type="button" data-toggle="tooltip" data-placement="top" data-html="true" onclick="ClearProduct(this,'taxType')"><i class="fa fa-refresh" aria-hidden="true"></i></button>

                                                                    </div>

                                                                   
                                                                </div>
                                                             
                                                            </div>
                                                        </div>
                                                        <div class="row">

                                                            <div class="col-sm-4">
                                                                <div class="form-group row" perfect-class="formGroup">
                                                                    <label class="col-sm-4 col-form-label">
                                                                        <span perfect-class="formGroupLabel"></span>

                                                                    </label>
                                                                    @*<div class="col-sm-5">
                                                                      <input type="checkbox" class="form-check-input" id="PercentageCheck" name="Percentage" perfect-class="formCheckInput" perfect-tempTable-taxType="PercentageCheck" perfect-ctype="checkbox" perfect-css="checkbox" onchange="HidePercentage(this);"><span perfect-class="formCheckInputText">Percentage </span>

                                                                        </div>*@
                                                                    <div class="col-sm-5" id="checkboxContainer" style="display: None;">
                                                                        <input type="checkbox" class="form-check-input" id="PercentageCheck" name="Percentage" perfect-class="formCheckInput" perfect-tempTable-taxType="PercentageCheck" perfect-ctype="checkbox" perfect-css="checkbox">
                                                                        <span perfect-class="formCheckInputText">Percentage</span>
                                                                    </div>
                                                                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="text-danger temptableError"></span>
                                                                </div>

                                                            </div>
                                                            @*<div class="col-sm-4"style="display:none">
                                                                <div class="form-group row" perfect-class="formGroup">
                                                                    <label class="col-sm-4 col-form-label">
                                                                        <span perfect-class="formGroupLabel"></span>

                                                                    </label>
                                                                    <div class="col-sm-5">
                                                                        <input type="checkbox" class="form-check-input" name="TaxOnNetamount" perfect-class="formCheckInput" perfect-tempTable-taxType="Tax On Net Amount" perfect-ctype="checkbox" perfect-css="checkbox"onchange="HidePercentage(this);"><span perfect-class="formCheckInputText">Tax On Net Amount </span>
                                                                    </div>
                                                                </div>
                                                                
                                                            </div>*@
                                                          
                                                                    <div class="col-sm-12">

                                                                        <div class="form-group row" perfect-class="formGroup">

                                                                            <div class="table-responsive" perfect-tempTable="taxType"></div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>

                            </div>

                        </div>
                    </div>

                </div>

                <div class="card-footer text-right" perfect-class="formFooter">
                  
                    @if (ViewBag.PagedAccessRights.UsrrlMsAdd)
            {
                    <button id="addcompany-jq-addnewuser" type="button" class="btn btn-primary mr-3 " name="add" perfect-css="button" onclick="UpdateTaxGrouping(this)"><i class="fa fa-refresh fa-spin loaderClass "></i>Save</button>
                    }
                    <button type="button" class="btn btn-light" perfect-css="button" onclick="ResetButton(this)" name="reset">Clear</button>
                </div>
                    </div>
            </form>
            </div>
        </div>
        



    <script>

        (function () {
            // jQuery('form').validate();//<-----  Validate/initialize our form on page load
            jQuery('select').selectpicker();
        })();

        function HidePercentage(ele) {
            debugger
            let $thisForm = $(ele).closest('[perfect-class="formGroup"]');
            if ($('#PercentageCheck').is(':checked')) {
                $('#PercentText').show();
                $('#AmountText').hide(); 
                $('#AmountWise').val(0); 
                $thisForm.find('[perfect-tempTable-taxType="Tax On Net Amount"]').prop('checked', false);

                $('#Amountlabel').hide();
                
            } else {
               // $('#PercentText').hide() ;
                $('#AmountText').show();
                $('#Amountlabel').show();
                $('#TaxPercentage').val("0"); 
                $thisForm.find('[perfect-tempTable-taxType="PercentageCheck"]').prop('checked', false);
            }
        }

        
        function ResetButton(ele) {




            fn_TaxGroupingIndex_initialLoad();

        }

        function AddTaxType(ele) {
            //formGroupLabel
            let flag = false;
            let $tempTable = $(ele).closest('[perfect-class=TempTableGroup]').find('[perfect-class=TempTable]');
            let $thead = $('<thead/>');
            if ($tempTable.find('thead').length = 0) {
                let $rowh = $('<tr/>');
                $(ele).closest('[perfect-class=TempTableGroup]').find('[perfect-class="formGroupLabel"]').each(function () {
                    let $this = $(this);
                    $rowh.append($('<th>').text($this.text()));
                });
                $thead.append($rowh)
            }

            let $row = $('<tr/>', { class: "taxStep" });

            $(ele).closest('[perfect-class=TempTableGroup]').find('[perfect-class="formGroupControl"]').each(function () {
                let $this = $(this);
                $row.append($('<td>', { name: $this.attr('name') }).text($this.val()));

            });
          
            $tempTable.append($row.append($('<button/>', { class: 'btn btn-primary fa fa-times' }).click(function () { $(this).closest('tr').remove(); })));

            $sidemenu.html(pft_table_createtable(data.Data, tableOptionsData))
            $sidemenu.find('table').dataTable({ paging: true, serialNo: true });
            
        }


        function addToTempTable(ele, val) {
            debugger


            let AmountWise = $('[name=AmountWise]').val() == null || $('[name=AmountWise]').val() == "" || $('[name=AmountWise]').val() == undefined ? 0 : $('[name=AmountWise]').val();

           // alert(AmountWise);

            $('[name=AmountWise]').val(AmountWise);


           

            let hide = ["ID_TaxType"];
            let uniqID = ["ID_TaxType"];
            let remValidate = ["Amount Wise"]

            let errorClass = '.temptableError';

            let $container = $(ele).closest('[perfect-class="form"]')
            //.find('[perfect-tempTable="' + val + '"]');
            let isvalid = true;
            let $tbl = $container.find('[perfect-tempTable="' + val + '"]');
            debugger
            let savedData = [];
            $container.find('[perfect-tempTable="' + val + '"]').find('tbody').find('tr').each(function () {
                savedData.push($(this).data('pData'));
            })
            //validate
            $container.find('[perfect-tempTable-' + val + ']').each(function () {
                let $this = $(this);

                debugger
                if (!remValidate.includes($this.attr('perfect-tempTable-' + val))) {
                   
                    if ($this.val().trim().length == 0) {
                        $this.closest('.PerError').find(errorClass).text('Please Enter' + $this.attr('perfect-tempTable-' + val));
                        isvalid = false;
                    }
                    else {
                        $this.closest('.PerError').find(errorClass).text('');
                    }
                }
                let $thisForm = $(ele).closest('[perfect-class="formGroup"]');
                debugger
                let valmethod = $thisForm.find('[perfect-tempTable-' + val + '="TaxPercentage"]').val();
                if (valmethod > 100) {
                    $thisForm.find('[perfect-tempTable-' + val + '="TaxPercentage"]').closest('[perfect-class="formGroup"]').find(errorClass).text('Please Enter Percentage in Between 1 to 100');
                    isvalid = false;
                }
                else {
                    $thisForm.find('[perfect-tempTable-' + val + '="TaxPercentage"]').closest('[perfect-class="formGroup"]').find(errorClass).text('');
                }
           

                if (uniqID.length>0) {
                    uniqID.forEach(function (key, value) {
                        console.log('uniq' + key + '|' + value);
                        let cvalue = $container.find('[perfect-tempTable-' + val + '="' + key+'"]').val();
                        console.log(cvalue)
                        console.log(savedData)
                        if (savedData.find(a => a[key] == cvalue)) {
                            console.log('inside cval==key')

                            isvalid = false;
                            $this.closest('.PerError').find(errorClass).text('Already Exist');
                        }
                    });

                }
            });

            if (isvalid) {
                let rhead = $('<tr />', { class: "btn-reveal-trigger" });
                let rbody = $('<tr />', { class: "btn-reveal-trigger" });
                let tempSave = {};
                if ($tbl.find('table').length== 0) {
                    let $table = $('<table />', { class: "table mb-0  table-striped  text-black" });
                    let $thead = $('<thead />', { class: "bg-primary text-white" })
                    let $tbody = $('<tbody />');
                    debugger
                    $container.find('[perfect-tempTable-' + val + ']').each(function () {
                        let $this = $(this);
                        if (!hide.includes($this.attr('perfect-tempTable-' + val))) {
                            rhead.append($('<th />').text($this.attr('perfect-tempTable-' + val)))


                            if ($this.attr('type') == 'checkbox') {
                                rbody.append($('<td />', { 'perfect-tempTable-td-name': $this.attr('name') }).html($('<i />', { class: ($this.is(':checked') ? "fa fa-check text-success" : "fa fa-times text-danger") })))
                            }
                            else {
                                rbody.append($('<td />', { 'perfect-tempTable-td-name': $this.attr('name') }).text($this.val() == "" ? "0" : $this.val()))
                            }

                        }
                        debugger
                        if ($this.attr('type') == 'checkbox') {
                            tempSave[$this.attr('name')] = $this.is(':checked');
                        } else {
                            tempSave[$this.attr('name')] = $this.val();
                        }


                    });

                    //console.log('create', tempSave);
                    rbody.data({ 'pData': tempSave });

                    $thead.html(rhead.append('<th />'));
                    $tbody.html(rbody.append($('<td />', { class: "d-flex" }).append($('<button />', { class: "btn btn-danger shadow btn-xs sharp mr-1" }).html($('<i />', { class: 'fa fa-trash' }))

                        .click(function () {
                            debugger
                            if ($(this).closest('tbody').find('tr').length == 1) {
                                $(this).closest('[perfect-temptable="' + val + '"]').empty();
                                $container.find('.PerError').find(errorClass).text('');
                                $container.find('[perfect-tempTable-' + val + '][type=text]').val('');
                                $container.find('[perfect-tempTable-' + val + '][type=hidden]').val('');
                                $container.find('[perfect-tempTable-' + val + '][type=number]').val('');
                                $container.find('[perfect-tempTable-' + val + '][type=checkbox]').prop('checked', false)
                            } else {
                                $(this).closest('tr').remove();
                            }
                        }))));
                    $tbl.html($table.append($thead).append($tbody))
                    $container.find('[perfect-tempTable-' + val + '][type=text]').val('');
                    $container.find('[perfect-tempTable-' + val + '][type=hidden]').val('');
                    $container.find('[perfect-tempTable-' + val + '][type=number]').val('');
                    $container.find('[perfect-tempTable-' + val + '][type=checkbox]').prop('checked', false)
                }
                else {

                    $container.find('[perfect-tempTable-' + val + ']').each(function () {
                        let $this = $(this);
                        if (!hide.includes($this.attr('perfect-tempTable-' + val))) {
                            if ($this.attr('type') == 'checkbox') {
                                rbody.append($('<td />', { 'perfect-tempTable-td-name': $this.attr('name') }).html($('<i />', { class: ($this.is(':checked') ? "fa fa-check text-success" : "fa fa-times text-danger") })))
                            }
                            else {
                                //rbody.append($('<td />', { 'perfect-tempTable-td-name': $this.attr('name') }).text($this.val()))
                                rbody.append($('<td />', { 'perfect-tempTable-td-name': $this.attr('name') }).text($this.val() == "" ? "0" : $this.val()))
                            }
                        }
                        if ($this.attr('type') == 'checkbox') {
                            tempSave[$this.attr('name')] = $this.is(':checked');
                        } else {
                            tempSave[$this.attr('name')] = $this.val();
                        }
                    });
                    // console.log('create', tempSave);
                    rbody.data({ 'pData': tempSave });
                    $tbl.find('tbody').append(rbody.append($('<td />', { class: "d-flex" }).append($('<button />', { class: "btn btn-danger shadow btn-xs sharp mr-1" }).html($('<i />', { class: 'fa fa-trash' }))
                        .click(function () {
                            debugger
                            console.log('len', $(this).closest('tbody').find('tr').length);
                            if ($(this).closest('tbody').find('tr').length == 1) {
                                $(this).closest('[perfect-temptable="' + val + '"]').empty();
                                $container.find('.PerError').find(errorClass).text('');
                                $container.find('[perfect-tempTable-' + val + '][type=hidden]').val('');
                                $container.find('[perfect-tempTable-' + val + '][type=text]').val('');
                                $container.find('[perfect-tempTable-' + val + '][type=number]').val('');
                                $container.find('[perfect-tempTable-' + val + '][type=checkbox]').prop('checked', false)
                                console.log('inside ');
                            } else {
                                $(this).closest('tr').remove();
                            }
                        }))));
                    debugger
                    $container.find('[perfect-tempTable-' + val + '][type=hidden]').val('');
                    $container.find('[perfect-tempTable-' + val + '][type=text]').val('');
                    $container.find('[perfect-tempTable-' + val + '][type=number]').val('');
                    $container.find('[perfect-tempTable-' + val + '][type=checkbox]').prop('checked', false)
                }
                HidePercentage();
            }
        }

        function searchbtn(ele) {

            console.log('Search function run')
            let $this = $(ele).closest('[perfect-class="formGroup"]');

            $.ajax({
                url: '@Url.Action("GetTaxType", "TaxGrouping")',
                type: "Get",
                headers: { "token_key": "1234" },
                //data: { branchID: id },
                dataType: "json",
                contentType: "application/json",
                success: function (successData) {
                    console.log('> Search button click success', successData);

                    if (successData.Process.IsProcess) {


                        var sss = createSelectList({
                            data: successData.Data, hideColumn: ['ID_TaxType', 'TaxPercentage', 'AmountWise', 'Percentage', 'TaxOnNetamount'],
                            renameHeader: { TaxtyName: "Tax Type" }
                        });
                        sss.then(function (ret) {
                            if (ret) {
                                console.log('>_ Search button > list click', ret);
                                $this.find('[name=ID_TaxType]').val(ret.ID_TaxType);
                                $this.find('[name=TaxtyName]').focus().val(ret.TaxtyName);
                                $this.find('table').append($('<tr>').append($('<td/>').text(ret.TaxtyName)).append($('<td/>').html('&times;').click(function () { $(this).closest('tr').remove() })))
                            }
                            else {
                                console.log(ret);
                            }
                        });

                    }
                    else {
                        $.each(successData.Process.Message, function (key, value) {
                            //toastr.warning(value, "Error");
                            NotificationMessage({ 'type': 'error', 'heading': 'Error', 'message': value });
                        });
                    }




                },
                complete: function () {

                    //a.find('.dataTables_wrapper').css('width', '100%');
                }
            });

        }

        function UpdateTaxGrouping(ele) {

        let $thisForm = $(ele).closest('[perfect-class="form"]');
          
          
            let TempdData = [];
            $thisForm.find('[perfect-tempTable="taxType"]').find('tbody').find('tr').each(function () {
                TempdData.push($(this).data('pData'));
            })

            if ($thisForm.valid() && TempdData.length != 0) {
                $(ele).prop('disabled', true);


                let inputData = {

                    __RequestVerificationToken: $('[name="__RequestVerificationToken"]').val(),

                    'TaxGroupID': 0,

                    'Name': $thisForm.find('[name="Name"]').val().trim(),
                    'ShortName': $thisForm.find('[name="ShortName"]').val().trim(),
                    'SortOrder': $thisForm.find('[name="SortOrder"]').val().trim(),
                    'TaxTypeDetails': TempdData,

                };

                $.ajax({
                    url: "@Url.Action("UpdateTaxGrouping", "TaxGrouping")",
                    type: "POST",
                    data: inputData,
                    dataType: "json",
                    contentType: "application/x-www-form-urlencoded; charset=utf-8",
                    success: function (ajaxOutput) {

                        if (ajaxOutput.Process.IsProcess) {

                            $.each(ajaxOutput.Process.Message, function (key, value) {
                                NotificationMessage({ 'type': 'success', 'heading': 'Success', 'message': value });
                            });

                            // Get the value set in form's perfect-onFormSuccess attribute
                            let onSuccess = $thisForm.attr('perfect-onFormSuccess');

                            if (onSuccess) {
                                window[onSuccess]();
                            }
                        }
                        else {
                            $.each(ajaxOutput.Process.Message, function (key, value) {
                                NotificationMessage({ 'type': 'error', 'heading': 'Error', 'message': value });
                            });
                        }
                    },
                    complete: function () {
                        $(ele).prop('disabled', false);
                    }

                });
            }


            else
            {

                    let $modal = createSearchModalDOM();

                    let $message = '<span>Enter Atleast One Tax details!!!</span>';
                    $modal.modal.find('.modal-body')
                        .addClass('text-black')
                        .html($message);
                    $modal.modal.find('.modal-title')
                        .addClass('text-primary')
                        .text('Message');

                    $modal.modal.show();
                }

            }

        
      

        function generateShortName(ele) {
            var fullName = document.getElementById('idname').value;
            var shortName = generateShortNameFromFullName(fullName);
            document.getElementById('idshortname').value = shortName;
        }    
    
        function decimalpnt(ele, name, range) {

            let input = $('#' + name);
            ele.value = ele.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');
            let t = ele.value;
            ele.value = (t.indexOf(".") >= 0) ? (t.substr(0, t.indexOf(".")) + t.substr(t.indexOf("."), range)) : t;
            input.on('keydown', function () {
                if (ele.value.includes('.')) {

                }
                var key = event.keyCode || event.charCode;
                if (key == 8 || key == 46) { }
                else {
                    if (ele.value.length == 10) {
                        ele.value = ele.value + '.';
                    }
                }

            });

        }

        function fn_createProductTable(element, tkey, uniq) {
            debugger
            let $thisForm = $(element).closest('[perfect-class="form"]');
            let tableKey = tkey;
            let $tblcontainer = $thisForm.find('[perfect-tempTable="' + tableKey + '"]');

            let insertData = {};
            let tableOptionsTemp = tableOptionsTempOut;

            let unique = (uniq) ? uniq : [];

            let isValid = true;
            let errorClass = '.temptableError';


            let lastIndex = ($tblcontainer.attr('perfect-tempTable-lastindex')) ? parseInt($tblcontainer.attr('perfect-tempTable-lastindex')) : 0;
            let thisactionIndex = ($tblcontainer.attr('perfect-tempTable-action')) ? parseInt($tblcontainer.attr('perfect-tempTable-action')) : 0;
            let indexname = tkey + 'index';
            tableOptionsTemp.rowAttribute.push(indexname);
            tableOptionsTemp.hideColumn.push(indexname);
            let updateCond = '';
            let isNew = true;

            if (thisactionIndex > 0) {
                insertData[indexname] = thisactionIndex;
                updateCond = '[' + indexname + '="' + thisactionIndex + '"]';
                isNew = false;
            }
            else {
                insertData[indexname] = lastIndex + 1;
                $tblcontainer.attr('perfect-tempTable-lastindex', lastIndex + 1);
                isNew = true;
            }

            if ($thisForm.find('[perfect-tempTable-' + tableKey + '="ID_TaxType"]').val().length == 0 || $thisForm.find('[perfect-tempTable-' + tableKey + '="ID_TaxType"]').val().length == null) {
                isValid = false;

                $thisForm.find('[perfect-tempTable-' + tableKey + '="ID_TaxType"]').closest('[perfect-class="formGroup"]').find(errorClass).text('Please select TaxType');
            }
            else {
                $thisForm.find('[perfect-tempTable-' + tableKey + '="ID_TaxType"]').closest('[perfect-class="formGroup"]').find(errorClass).text('');
            }


         
            if ($thisForm.find('[perfect-tempTable-' + tableKey + '="Tax On Net Amount"]').is(':Checked') == true) {
                debugger
               
                $thisForm.find('[name="ProdAll"]').prop('checked', true);
                let amountval = $thisForm.find('[perfect-tempTable-' + tableKey + '="Amount Wise"]').val();
                if (amountval <= 0 || amountval == '' || amountval== undefined) {
                    $thisForm.find('[perfect-tempTable-' + tableKey + '="Amount Wise"]').closest('[perfect-class="formGroup"]').find(errorClass).text('Please Enter Amount Greater than Zero');
                    isValid = false;
                }
                else {
                    $thisForm.find('[perfect-tempTable-' + tableKey + '="Amount Wise"]').closest('[perfect-class="formGroup"]').find(errorClass).text('');
                }
            }
           
         
            if ($thisForm.find('[perfect-tempTable-' + tableKey + '="PercentageCheck"]').is(':Checked') == true) {

              
                debugger
                let valmethod = $thisForm.find('[perfect-tempTable-' + tableKey + '="Percentage"]').val();
                if (valmethod > 100 || valmethod == 0 || valmethod == undefined) {
                    $thisForm.find('[perfect-tempTable-' + tableKey + '="Percentage"]').closest('[perfect-class="formGroup"]').find(errorClass).text('Please Enter Percentage in Between 1 to 100');
                    isValid = false;
                }
                else {
                    $thisForm.find('[perfect-tempTable-' + tableKey + '="Percentage"]').closest('[perfect-class="formGroup"]').find(errorClass).text('');
                }
            }

          

            //if (($thisForm.find('[perfect-tempTable-' + tableKey + '="PercentageCheck"]').is(':Checked') == false) && ($thisForm.find('[perfect-tempTable-' + tableKey + '="Tax On Net Amount"]').is(':Checked') == false)) {

            //    //$thisForm.find('[perfect-tempTable-' + tableKey + '="Amount Wise"]').closest('[perfect-class="formGroup"]').find(errorClass).text('Please mark any of the check boxes');
            //    NotificationMessage({ 'type': 'error', 'heading': 'Error', 'message': 'Please mark any of the check boxes' });
            //    isValid = false;
            //}
           
            //if (($thisForm.find('[perfect-tempTable-' + tableKey + '="PercentageCheck"]').is(':Checked') == true) && ($thisForm.find('[perfect-tempTable-' + tableKey + '="Tax On Net Amount"]').is(':Checked') == true)) {

            //   // $thisForm.find('[perfect-tempTable-' + tableKey + '="ID_TaxType"]').closest('[perfect-class="formGroup"]').find(errorClass).text('Please mark any one of the check boxes');
            //    NotificationMessage({ 'type': 'error', 'heading': 'Error', 'message': 'Please mark any one of the check boxes' });
            //    isValid = false;
            //}
            

            if (unique.length > 0) {
                let prevData = [];
                $tblcontainer.find('table > tbody').find('tr').each(function () {
                    if (isNew) {
                        prevData.push($(this).data('pData'));
                    }
                    else {
                        if (parseInt($(this).attr(indexname)) != thisactionIndex) {
                            prevData.push($(this).data('pData'));
                        }

                    }

                })
                unique.forEach(function (key, i) {
                    let $thisEle = $thisForm.find('[perfect-tempTable-' + tableKey + '="' + key + '"]');
                    let headerEleName = $thisForm.find('[name="lblType"]').text();
                    let atname = $thisEle.attr('name');
                    let cvalue;


                    if ($thisEle.length != 0) {
                        let $errorElement = $thisEle.closest('[perfect-class="formGroup"]').find(errorClass);
                        let errmessage = headerEleName + " Already exits"

                        if ($thisEle.is('select')) {
                            cvalue = $thisEle.val();

                        }
                        else if ($thisEle.is('input')) {

                            let inputEleType = $thisEle.attr('type').toLocaleLowerCase();

                            if (inputEleType == 'checkbox') { cvalue = $thisEle.is(':checked'); }
                            else if (inputEleType == 'hidden') { cvalue = $thisEle.val(); }
                            else { cvalue = $thisEle.val(); }
                        }
                        else {
                            cvalue = $thisEle.val();
                        }

                        if (prevData.find(a => a[atname] == cvalue)) {
                            $errorElement.text(errmessage);
                            isValid = false;
                        }
                    }
                });

            }

            if (isValid) {
                $thisForm.find('[perfect-tempTable-' + tableKey + ']').each(function () {
                    let $this = $(this);
                    let headerName = $this.attr('perfect-tempTable-' + tableKey);
                    let nameAttr = $this.attr('name');
                    if ($this.is('select')) {

                        tableOptionsTemp.renameHeader[nameAttr + '_d'] = headerName;
                        tableOptionsTemp.hideColumn.push(nameAttr)
                        if ($this.val() != null) {
                            let selectText = ($this.val().length == 0) ? '' : $this.children(":selected").text();
                            insertData[nameAttr + '_d'] = selectText;
                        }
                        else {
                            let selectText = ($this.val() == null) ? '' : $this.children(":selected").text();
                            insertData[nameAttr + '_d'] = selectText;
                        }
                        insertData[nameAttr] = $this.val();

                        $this.val('').selectpicker('refresh');
                    }
                    else if ($this.is('input')) {

                        let inputType = $this.attr('type').toLocaleLowerCase();

                        if (inputType == 'checkbox') {

                            insertData[nameAttr] = $this.is(':checked');

                            tableOptionsTemp.isCheckType.push(nameAttr)
                          //  $this.prop('checked', false);

                        }
                        else if (inputType == 'hidden') {
                            insertData[nameAttr] = $this.val();
                            $this.val('');

                        }

                        else {
                            insertData[nameAttr] = $this.val();

                            $this.val('');
                        }
                    }
                    else {
                        insertData[nameAttr] = $this.val();

                        $this.val('');
                    }
                });

                if (isNew) {
                    if ($tblcontainer.find('table').length == 0) {
                        $tblcontainer.append(pft_table_createtable([insertData], tableOptionsTemp));
                    }
                    else {
                        let table = $tblcontainer.find('table').DataTable()
                        table.destroy()
                        pft_table_addTableRow($tblcontainer.find('table'), insertData, tableOptionsTemp);
                    }
                }
                else {
                    let table = $tblcontainer.find('table').DataTable()
                    table.destroy()
                    pft_table_replaceTableRow($tblcontainer.find('table'), updateCond, insertData, tableOptionsTemp);
                }

                $tblcontainer.attr('perfect-tempTable-action', 0);
               // $('#PercentText').hide();
                $('#AmountText').show();
                $('#Amountlabel').show();
                $('#TaxPercentage').val("0");
               // $thisForm.find('[perfect-tempTable-taxType="PercentageCheck"]').prop('checked', false);
                //$thisForm.find('[name="AldAmountTo"]').attr('readonly', true);
            }
        }

        var tableOptionsTempOut= {
            iconButton: {
                buttons: [
                    {
                        icon: "fa fa-pencil btnPerfectGridEdit",
                        action: function () {
                            let savedData = $(this).closest('tr').data('pData')
                           
                            let $tablecontainer = $(this).closest('[perfect-tempTable]');
                            let tableKey = $tablecontainer.attr('perfect-tempTable');
                            let $thisForm = $tablecontainer.closest('[perfect-class="form"]');
                            let indexname = tableKey + 'index';
                            let rindex = $(this).closest('tr').attr(indexname);
                            $tablecontainer.attr('perfect-tempTable-action', rindex);
                            $thisForm.find('[perfect-tempTable-' + tableKey + ']').each(function () {
                                let $thisNode = $(this);
                                let pf_name = $thisNode.attr('name');
                                if ($thisNode.is('select')) {

                                    $thisNode.val(savedData[pf_name]).selectpicker('refresh');
                                }
                                else if ($thisNode.is('input')) {

                                    if ($thisNode.attr('type').toLocaleLowerCase() == 'checkbox') {

                                        $thisNode.prop('checked', savedData[pf_name]);
                                    }
                                    else {

                                        $thisNode.val(savedData[pf_name]);
                                    }

                                }
                                else {
                                    $thisNode.val(savedData[pf_name]);
                                }


                            });
                        }
                    },

                    {

                        icon: "fa fa-trash btnPerfectGridDelete",
                        action: function () {
                            let $thistbl = $(this).closest('table');
                            let table = $thistbl.DataTable();
                            table.destroy();
                            if ($(this).closest('tbody').find('tr').length > 1) {
                                $(this).closest('tr').remove();
                                pft_table_slreset($thistbl);

                            }
                            else {

                                $thistbl.remove();
                            }
                            $("#reset").click();

                        }
                    },
                ]
            },
            onlyShowColumn: [],
            hideColumn: ['ID_TaxType','Percentage'],
            serialNo: true,
            renameHeader: {
                "TaxtyName": "Tax Type"
            },
            rowAttribute: [],
            isCheckType: []
        };

        function ClearProduct(ele, tablekey) {

            let $thisform = $(ele).closest('[perfect-class="form"]');
            $thisform.find('[perfect-temptable-' + tablekey + ']').closest('[perfect-ctype="input"]').val('');
            $thisform.find('[perfect-temptable-' + tablekey + ']').closest('[perfect-ctype="text"]').val('');
            $thisform.find('[perfect-temptable-' + tablekey + ']').closest('[perfect-ctype="select"]').val('').selectpicker('refresh');
            $thisform.find('[perfect-temptable-' + tablekey + ']').closest('[perfect-ctype="input"]').val('');
            $thisform.find('[perfect-temptable-' + tablekey + ']').closest('[perfect-ctype="date"]').val('');
            $thisform.find('[perfect-temptable-' + tablekey + ']').closest('[perfect-ctype="hidden"]').val('');
            $('input[type=checkbox]').prop('checked', false);
            let $tblcontainer = $thisform.find('[perfect-tempTable="' + tablekey + '"]');
            let lastIndex = ($tblcontainer.attr('perfect-tempTable-lastindex')) ? parseInt($tblcontainer.attr('perfect-tempTable-lastindex')) : 0;
            $tblcontainer.attr('perfect-tempTable-action', 0);
            $thisform.find('[name=prdbtn]').removeAttr("disabled", "disabled");
         //   $('#PercentText').hide();
            $('#AmountText').show();
            $('#Amountlabel').show();
            $('#TaxPercentage').val("0");
            $thisForm.find('[perfect-tempTable-taxType="PercentageCheck"]').prop('checked', false);
            


        }
    </script>